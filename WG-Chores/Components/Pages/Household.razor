@page "/household/{Code}"
@using Microsoft.AspNetCore.Components
@using WG_Chores.Data
@using System.Linq
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@inject IHouseholdService HouseholdService
@inject NavigationManager Nav
@inject IJSRuntime JS

<PageTitle>Household</PageTitle>

<div class="container-fluid p-3" style="padding-bottom:120px;">
    @if (loading)
    {
        <div>Loading...</div>
    }
    else if (household == null)
    {
        <div class="alert alert-warning">Household not found.</div>
        <button class="btn btn-link" @onclick="GoHome">Back</button>
    }
    else
    {
        <div class="row">
            <div class="col-12 col-md-8">
                <div class="p-0">
                    <div class="d-flex justify-content-end mb-2">
                        <div class="dropdown position-relative">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" @onclick="ToggleSortMenu" title="Sort">
                                <i class="fa-solid fa-filter" aria-hidden="true"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end @(showSortMenu ? "show" : "")" style="right:0; left:auto;">
                                <li><button class="dropdown-item @(sortMode == SortMode.Category ? "active" : "")" type="button" @onclick="() => SetCategorySort()">Category</button></li>
                                <li>
                                    <button class="dropdown-item d-flex justify-content-between align-items-center @(sortMode == SortMode.Time ? "active" : "")" type="button" @onclick="() => SetTimeSort()">
                                        <span>Time</span>
                                        <span class="ms-2 small text-muted">@((sortMode == SortMode.Time) ? (timeAsc ? "â†‘" : "â†“") : "")</span>
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                        @if (household.Chores == null || !household.Chores.Any())
                        {
                            <div class="text-muted">No chores yet.</div>
                        }
                        else
                        {
                            if (sortMode == SortMode.Category)
                            {
                                var groups = household.Chores
                                    .GroupBy(c => string.IsNullOrWhiteSpace(c.Room) ? "General" : c.Room)
                                    .OrderBy(g => g.Key);

                                foreach (var grp in groups)
                                {
                                    <div class="mb-3">
                                        <div class="mb-1">
                                            <strong>@grp.Key</strong>
                                        </div>
                                        <ul class="list-group list-group-flush">
                                            @foreach (var c in grp.OrderBy(x => x.Title))
                                            {
                                                var isSelected = selectedChores.Contains(c.Id);
                                                <li class="list-group-item border-0 px-0 py-2 @(isSelected ? "list-group-item-success text-white rounded-1" : string.Empty)" style="cursor:pointer;" @onclick="() => OnChoreClick(c)">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>@c.Title</div>
                                                        <div class="text-end">
                                                            <small class="text-muted ms-2">@GetLastCompletedText(c.Id)</small>
                                                            @if (showMemberNames)
                                                            {
                                                            <small class="text-muted">@GetLastCompletedMember(c.Id)</small>
                                                            }
                                                        </div>
                                                    </div>
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                }
                            }
                            else if (sortMode == SortMode.Time)
                            {
                                // flat list ordered by last completed date
                                var ordered = timeAsc
                                    ? household.Chores.OrderBy(c => GetChoreDoneAt(c.Id))
                                    : household.Chores.OrderByDescending(c => GetChoreDoneAt(c.Id));

                                <ul class="list-group list-group-flush">
                                    @foreach (var c in ordered)
                                    {
                                        var isSelected = selectedChores.Contains(c.Id);
                                        <li class="list-group-item border-0 px-0 py-2 @(isSelected ? "list-group-item-success text-white rounded-1" : string.Empty)" style="cursor:pointer;" @onclick="() => OnChoreClick(c)">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <div>@c.Title</div>
                                                    <small class="text-muted">@c.Room</small>
                                                </div>
                                                <div class="text-end">
                                                    <small class="text-muted ms-2">@GetLastCompletedText(c.Id)</small>
                                                    @if (showMemberNames)
                                                    {
                                                    <small class="text-muted">@GetLastCompletedMember(c.Id)</small>
                                                    }
                                                </div>
                                            </div>
                                        </li>
                                    }
                                </ul>
                            }
                        }
                    </div>
            </div>
        </div>
    }
</div>

    <div class="fixed-bottom bg-light border-top">
        <div class="container-fluid py-2">
            <div class="d-flex flex-column flex-sm-row justify-content-between align-items-center gap-2">
                <div class="d-flex gap-2 w-100">
                    <button class="btn btn-outline-success flex-fill flex-sm-none" type="button" @onclick="MarkSelectedChoresAsync">Chores completed</button>
                    <div class="d-flex align-items-center">
                        <span class="me-2">ðŸ“…</span>
                        <input type="date" class="form-control" style="width:160px; min-width:120px;" @bind="selectedDate" />
                    </div>
                </div>

                <div class="d-flex gap-2 w-100 justify-content-sm-end">
                    <button class="btn btn-outline-secondary me-2" type="button" title="@(showMemberNames ? "Hide member names" : "Show member names")" @onclick="ToggleShowMemberNames">
                        <i class="fa @(showMemberNames ? "fa-eye" : "fa-eye-slash")" aria-hidden="true"></i>
                    </button>
                    <button class="btn btn-secondary w-100 w-sm-auto" type="button" @onclick="ToggleEditChores">@(editingChores ? "Done" : "Edit chores")</button>
                    <button class="btn btn-primary w-100 w-sm-auto" type="button" @onclick="OpenAddModal">Add chore</button>
                </div>
            </div>
        </div>
    </div>

    

@if (showAddModal)
{
    <div class="modal-backdrop fade show"></div>
    <div class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="z-index:1050;">
        <div class="card" style="width:420px;">
                <div class="card-body">
                    <h5 class="card-title">@(editingChore != null ? "Edit chore" : "Add chore")</h5>
                    <div class="mb-3">
                        <label class="form-label">Chore name</label>
                        <input class="form-control" @bind="newChoreTitle" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Room</label>
                        <input class="form-control" @bind="newChoreRoom" />
                    </div>
                    <div class="d-flex justify-content-end">
                        @if (editingChore != null)
                        {
                            <button class="btn btn-danger me-2" @onclick="DeleteChoreAsync">Delete</button>
                        }
                        <button class="btn btn-link me-2" @onclick="CloseAddModal">Cancel</button>
                        <button class="btn btn-primary" @onclick="SubmitAddChoreAsync" disabled="@string.IsNullOrWhiteSpace(newChoreTitle)">@(editingChore != null ? "Save" : "Add")</button>
                    </div>
                </div>
        </div>
    </div>
}

@code {
    [Parameter] public string? Code { get; set; }

    private WG_Chores.Data.Household? household;
    private bool loading = true;
    private bool showAddModal = false;
    private string newChoreTitle = string.Empty;
    private string newChoreRoom = string.Empty;
    private bool editingChores = false;
    private WG_Chores.Data.Chore? editingChore;
    private HashSet<int> selectedChores = new();
    private DateTime selectedDate = DateTime.Today;
    private Dictionary<int, (DateTime? DoneAt, string? MemberName)> lastDone = new();
    private int? currentMemberId;
    private string? currentMemberName;
    private bool showMemberNames = false;

    protected override async Task OnParametersSetAsync()
    {
        await Load();
    }

    private async Task Load()
    {
        loading = true;
        if (string.IsNullOrWhiteSpace(Code))
        {
            household = null;
        }
        else
        {
            // Get basic household by code first
            var basic = await HouseholdService.GetByCodeAsync(Code!);
            if (basic == null)
            {
                household = null;
            }
            else
            {
                // Ensure chores (and members) are loaded by fetching the full household
                household = await HouseholdService.GetByIdAsync(basic.Id);
            }
        }
        // load last done dates for chores
        lastDone.Clear();
        // load current member info from localStorage (if available)
        try
        {
            var idStr = await JS.InvokeAsync<string?>("localStorage.getItem", "wg_member_id");
            if (int.TryParse(idStr, out var mid)) currentMemberId = mid;
            currentMemberName = await JS.InvokeAsync<string?>("localStorage.getItem", "wg_member_username");
        }
        catch
        {
            currentMemberId = null;
            currentMemberName = null;
        }
        // load saved preference for showing member names
        try
        {
            var showStr = await JS.InvokeAsync<string?>("localStorage.getItem", "wg_show_member_names");
            if (bool.TryParse(showStr, out var s)) showMemberNames = s;
        }
        catch { }
        if (household != null && household.Chores != null && household.Chores.Any())
        {
            var chores = household.Chores.ToList();
            var tasks = chores.Select(async c =>
            {
                try
                {
                    var hist = await HouseholdService.GetChoreHistoryAsync(c.Id);
                    var histSorted = hist.OrderByDescending(h => h.DoneAt);
                    var latestEntry = histSorted.FirstOrDefault();
                    lock (lastDone)
                    {
                        lastDone[c.Id] = (latestEntry?.DoneAt, latestEntry?.MemberName);
                    }
                }
                catch
                {
                    lock (lastDone) { lastDone[c.Id] = (null, null); }
                }
            }).ToArray();

            await Task.WhenAll(tasks);
        }
        loading = false;
        StateHasChanged();
    }

    private async Task Refresh() => await Load();

    private void GoHome() => Nav.NavigateTo("/");

    private void OpenAddModal()
    {
        newChoreTitle = string.Empty;
        newChoreRoom = string.Empty;
        editingChore = null;
        showAddModal = true;
    }

    private void ToggleEditChores()
    {
        editingChores = !editingChores;
        // close any modal/edit state when toggling off
        if (!editingChores)
        {
            editingChore = null;
            showAddModal = false;
        }
    }

    private bool showSortMenu = false;
    private void ToggleSortMenu()
    {
        showSortMenu = !showSortMenu;
    }
    private enum SortMode { Category, Time }
    private SortMode sortMode = SortMode.Category;
    private bool timeAsc = true;

    private void SetCategorySort()
    {
        sortMode = SortMode.Category;
        showSortMenu = false;
    }

    private void SetTimeSort()
    {
        if (sortMode == SortMode.Time)
        {
            // toggle asc/desc
            timeAsc = !timeAsc;
        }
        else
        {
            sortMode = SortMode.Time;
            timeAsc = true; // default first press = ascending
        }
        showSortMenu = false;
    }

    private DateTime GetChoreDoneAt(int choreId)
    {
        if (lastDone.TryGetValue(choreId, out var entry) && entry.DoneAt.HasValue)
            return entry.DoneAt.Value.ToLocalTime();
        // treat never-done as very old so it appears first when sorting ascending
        return DateTime.MinValue;
    }

    // Date changes are handled by binding to `selectedDate` directly.

    private void OpenEditModal(WG_Chores.Data.Chore c)
    {
        editingChore = c;
        newChoreTitle = c.Title;
        newChoreRoom = c.Room ?? string.Empty;
        showAddModal = true;
    }

    private void OnChoreClick(WG_Chores.Data.Chore c)
    {
        if (editingChores)
        {
            OpenEditModal(c);
            return;
        }

        if (selectedChores.Contains(c.Id))
            selectedChores.Remove(c.Id);
        else
            selectedChores.Add(c.Id);
    }

    private void CloseAddModal()
    {
        showAddModal = false;
    }

    private async Task SubmitAddChoreAsync()
    {
        if (household == null) return;
        if (string.IsNullOrWhiteSpace(newChoreTitle)) return;

        if (editingChore != null)
        {
            // update existing chore
            var updated = new WG_Chores.Data.Chore
            {
                Id = editingChore.Id,
                Title = newChoreTitle.Trim(),
                Description = editingChore.Description,
                Room = string.IsNullOrWhiteSpace(newChoreRoom) ? null : newChoreRoom.Trim(),
                IsDone = editingChore.IsDone,
                HouseholdId = editingChore.HouseholdId,
                CreatedAt = editingChore.CreatedAt
            };
            await HouseholdService.UpdateChoreAsync(updated);
        }
        else
        {
            // Add chore to this household only
            await HouseholdService.AddChoreAsync(household.Id, newChoreTitle.Trim(), description: null, room: string.IsNullOrWhiteSpace(newChoreRoom) ? null : newChoreRoom.Trim());
        }

        showAddModal = false;
        editingChore = null;
        await Load();
    }

    private async Task DeleteChoreAsync()
    {
        if (editingChore == null) return;
        await HouseholdService.RemoveChoreAsync(editingChore.Id);
        showAddModal = false;
        editingChore = null;
        await Load();
    }

    private async Task MarkSelectedChoresAsync()
    {
        if (selectedChores == null || !selectedChores.Any()) return;
        // read current member info from localStorage (try every time to avoid timing issues)
        try
        {
            var idStr = await JS.InvokeAsync<string?>("localStorage.getItem", "wg_member_id");
            if (int.TryParse(idStr, out var mid)) currentMemberId = mid;
            currentMemberName = await JS.InvokeAsync<string?>("localStorage.getItem", "wg_member_username");
        }
        catch
        {
            currentMemberId = null;
            currentMemberName = null;
        }

        // If we have a username but not an id, attempt to resolve/ensure the member server-side
        if (currentMemberId == null && !string.IsNullOrWhiteSpace(currentMemberName) && household != null)
        {
            try
            {
                var member = await HouseholdService.JoinAsync(household.Code, currentMemberName);
                if (member != null)
                {
                    currentMemberId = member.Id;
                    currentMemberName = member.Username;
                    // store resolved id back to localStorage
                    try { await JS.InvokeVoidAsync("localStorage.setItem", "wg_member_id", member.Id.ToString()); } catch { }
                }
            }
            catch
            {
                // ignore resolution failures
            }
        }
        var tasks = new List<Task<WG_Chores.Data.ChoreHistory>>();
        foreach (var id in selectedChores)
        {
            // record history entry for the selected date; include current member if available
            tasks.Add(HouseholdService.AddChoreHistoryAsync(id, currentMemberId, currentMemberName, notes: null, doneAt: selectedDate));
        }

        try
        {
            await Task.WhenAll(tasks);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error recording chore history: {ex}");
        }

        // clear selection and refresh
        selectedChores.Clear();
        await Load();
    }

    private string GetLastCompletedText(int choreId)
    {
        if (!lastDone.TryGetValue(choreId, out var entry) || entry.DoneAt == null)
            return "Never";

        var doneDate = entry.DoneAt.Value.ToLocalTime().Date;
        var today = DateTime.Today;
        var days = (today - doneDate).Days;
        if (days == 0) return "Today";
        if (days == 1) return "1 day ago";
        return $"{days} days ago";
    }

    private string GetLastCompletedMember(int choreId)
    {
        if (!lastDone.TryGetValue(choreId, out var entry) || entry.DoneAt == null)
            return string.Empty;

        if (string.IsNullOrWhiteSpace(entry.MemberName))
            return " by Unknown";

        return $" by {entry.MemberName}";
    }

    private async Task ToggleShowMemberNames()
    {
        showMemberNames = !showMemberNames;
        try { await JS.InvokeVoidAsync("localStorage.setItem", "wg_show_member_names", showMemberNames.ToString()); } catch { }
    }
}
