@page "/"

@inject IHouseholdService HouseholdService
@inject NavigationManager Nav
@inject IJSRuntime JS
@using System.Reflection

<PageTitle>Login</PageTitle>

<div class="container-fluid d-flex align-items-center justify-content-center">
  <div style="max-width:420px; width:100%; box-sizing: border-box;" class="p-3">
      <div class="d-flex align-items-center mb-2">
        <div>
          <h4 class="mb-0">WG-Chores</h4>
          <small class="text-muted">Sign in to manage your household</small>
        </div>
      </div>

      <div class="mb-3 form-floating">
        <input id="username" class="form-control" placeholder="Username" @bind="username" />
        <label for="username">Username</label>
      </div>

      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="d-flex align-items-center" style="gap:12px;">
          <button class="btn btn-sm btn-outline-secondary" @onclick="ToggleCreate" disabled="@(!CanAct())">
            <span class="me-1">+</span>
            <span class="small">Create</span>
          </button>
          <small class="text-muted">or</small>
        </div>

        <div class="d-flex align-items-center" style="gap:8px;">
          <input class="form-control form-control-sm" placeholder="Join code" style="width:140px" @bind="joinCode" />
          <button class="btn btn-sm btn-primary" @onclick="Join">Join</button>
        </div>
      </div>

      @if (showCreateInput)
      {
        <div class="mb-3">
          <div class="input-group">
            <input class="form-control" placeholder="Household name" @bind="newHousehold" />
            <button class="btn btn-primary" @onclick="Create">Create</button>
            <button class="btn btn-outline-secondary" @onclick="() => showCreateInput = false">Cancel</button>
          </div>
        </div>
      }

      @if (!string.IsNullOrEmpty(status))
      {
        <div class="alert alert-info py-2 mt-2" role="status" style="white-space:pre-wrap">@status</div>
      }

      <div class="mt-3 text-center">
        <button class="btn btn-link btn-sm text-muted" @onclick="ForgotHousehold">Forgot household</button>
      </div>
      
      <!-- version visually placed at bottom but as part of page content -->
      <div style="position:fixed; left:0; right:0; bottom:0; text-align:right; padding:1rem 1rem; font-size:.85rem; color:#6c757d; background:transparent;" aria-hidden="true">
        Version: @appVersion
      </div>

      <div style="height:48px;" aria-hidden="true"></div>
    </div>
</div>

@code {
  private string? username;
  private string? newHousehold;
  private string? joinCode;
  private string? status;
  private string appVersion = "unknown";

  private bool showCreateInput = false;

  private bool CanAct() => !string.IsNullOrWhiteSpace(username);

  private void ToggleCreate()
  {
    showCreateInput = !showCreateInput;
    status = null;
  }

  private async Task Create()
  {
    if (!CanAct())
    {
      status = "Enter a username first.";
      return;
    }
    if (string.IsNullOrWhiteSpace(newHousehold))
    {
      status = "Enter a household name.";
      return;
    }

    try
    {
      var household = await HouseholdService.CreateAsync(newHousehold!.Trim(), username!.Trim());
      // After creating, join as the owner to get Member info and persist locally
      var member = await HouseholdService.JoinAsync(household.Code, username!.Trim());
      if (member != null)
      {
        await JS.InvokeVoidAsync("wgChores.setCookie", "wg_member_id", member.Id.ToString(), 365);
        await JS.InvokeVoidAsync("wgChores.setCookie", "wg_member_username", member.Username ?? string.Empty, 365);
        // remember last opened household code
        await JS.InvokeVoidAsync("wgChores.setCookie", "wg_household_code", household.Code, 365);
      }
      status = $"Created household '{household.Name}' — code: {household.Code}.";
      newHousehold = string.Empty;
      showCreateInput = false;
      Nav.NavigateTo($"/household/{household.Code}");
    }
    catch (Exception ex)
    {
      status = $"Error creating household: {ex.Message}" + (ex.InnerException != null ? $" - {ex.InnerException.Message}" : string.Empty);
      Console.Error.WriteLine(ex);
    }
  }

  private async Task Join()
  {
    if (!CanAct())
    {
      status = "Enter a username first.";
      return;
    }
    if (string.IsNullOrWhiteSpace(joinCode))
    {
      status = "Enter a household code.";
      return;
    }

    var code = joinCode!.Trim();

    try
    {
      var member = await HouseholdService.JoinAsync(code, username!.Trim());
      if (member == null)
      {
        status = "Household code not found or an error occurred.";
      }
      else
      {
        // persist member id/username locally so household pages can record history
        await JS.InvokeVoidAsync("wgChores.setCookie", "wg_member_id", member.Id.ToString(), 365);
        await JS.InvokeVoidAsync("wgChores.setCookie", "wg_member_username", member.Username ?? string.Empty, 365);
        // remember last opened household code
        await JS.InvokeVoidAsync("wgChores.setCookie", "wg_household_code", code, 365);
        status = $"Joined household (id: {member.HouseholdId}) as {member.Username}.";
        joinCode = string.Empty;
        Nav.NavigateTo($"/household/{code}");
      }
    }
    catch (Exception ex)
    {
      status = $"Error joining household: {ex.Message}" + (ex.InnerException != null ? $" - {ex.InnerException.Message}" : string.Empty);
      Console.Error.WriteLine(ex);
    }
  }

  private async Task ForgotHousehold()
  {
    if (string.IsNullOrWhiteSpace(username))
    {
      status = "Enter a username to search for households.";
      return;
    }

    try
    {
      var households = await HouseholdService.GetByUsernameAsync(username!.Trim());
      // also clear stored member info and last household
      await JS.InvokeVoidAsync("wgChores.deleteCookie", "wg_member_id");
      await JS.InvokeVoidAsync("wgChores.deleteCookie", "wg_member_username");
      await JS.InvokeVoidAsync("wgChores.deleteCookie", "wg_household_code");

      if (households == null || households.Count == 0)
      {
        status = "No households found for that username.";
      }
      else
        {
        status = string.Join("\n", households.Select(h => $"\"{h.Name}\" {h.Code}"));
      }
    }
    catch (Exception ex)
    {
      status = $"Error finding households: {ex.Message}";
      Console.Error.WriteLine(ex);
    }
  }

  protected override async Task OnInitializedAsync()
  {
    // determine application version from assembly attributes (strip any +commit suffix)
    try
    {
      var asm = Assembly.GetEntryAssembly() ?? Assembly.GetExecutingAssembly();
      var raw = asm?.GetCustomAttribute<AssemblyInformationalVersionAttribute>()?.InformationalVersion
                ?? asm?.GetName().Version?.ToString();
      if (string.IsNullOrWhiteSpace(raw)) appVersion = "unknown";
      else appVersion = raw.Split('+')[0];
    }
    catch { appVersion = "unknown"; }

    try
    {
      string code = await JS.InvokeAsync<string>("wgChores.getCookie", "wg_household_code");
      string storedUsername = await JS.InvokeAsync<string>("wgChores.getCookie", "wg_member_username");
      
      if (!string.IsNullOrWhiteSpace(code) && !string.IsNullOrWhiteSpace(storedUsername))
      {
        Nav.NavigateTo($"/household/{code}");
      }
    }
    catch { }
  }
}

