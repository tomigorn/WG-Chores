@page "/"
@layout LoginLayout

@inject IHouseholdService HouseholdService
@inject NavigationManager Nav
@inject IJSRuntime JS
@using System.Reflection

<PageTitle>Login</PageTitle>

<div class="login-page">
  <div class="login-card">
    <div class="login-header">
      <h1 class="login-title">WG-Chores</h1>
      <p class="login-subtitle">Manage your household</p>
    </div>

    <div class="login-form">
      @if (!string.IsNullOrWhiteSpace(storedHouseholdCode))
      {
        <a href="/household/@storedHouseholdCode" class="login-back-btn">
          @(storedHouseholdName ?? "Back to household")
        </a>
        <button type="button" class="login-other-link" @onclick="() => showOtherHouseholds = !showOtherHouseholds">
          <i class="fa-solid fa-chevron-@(showOtherHouseholds ? "up" : "down")" aria-hidden="true"></i>
          Other households
        </button>
      }

      @if (showOtherHouseholds || string.IsNullOrWhiteSpace(storedHouseholdCode))
      {
      <div class="form-floating mb-3">
        <input id="username" class="form-control" placeholder="Username" @bind="username" />
        <label for="username">Username</label>
      </div>

      <div class="login-actions">
        <div class="login-actions-row">
          <button class="btn btn-outline-secondary" @onclick="ToggleCreate" disabled="@(!CanAct())">
            <i class="fa-solid fa-plus" aria-hidden="true"></i>
            Create
          </button>
        </div>
        <div class="login-actions-row">
          <span class="login-or">or</span>
        </div>
        <div class="login-actions-row login-join-row">
          <input class="form-control" placeholder="Join code" @bind="joinCode" />
          <button class="btn btn-primary" @onclick="Join">Join</button>
        </div>
      </div>

      @if (showCreateInput)
      {
        <div class="login-create mb-3">
          <input class="form-control" placeholder="Household name" @bind="newHousehold" />
          <div class="login-create-btns">
            <button class="btn btn-outline-secondary" @onclick="() => showCreateInput = false">Cancel</button>
            <button class="btn btn-primary" @onclick="Create">Create</button>
          </div>
        </div>
      }

      @if (!string.IsNullOrEmpty(status))
      {
        <div class="login-status" role="status">@status</div>
      }

      <button class="btn btn-link login-forgot" @onclick="ForgotHousehold">Forgot household?</button>
      }
    </div>
  </div>

  <div class="login-version" aria-hidden="true">v @appVersion</div>
</div>

@code {
  private string? username;
  private string? newHousehold;
  private string? joinCode;
  private string? status;
  private string appVersion = "unknown";
  private string? storedHouseholdCode;
  private string? storedHouseholdName;

  private bool showCreateInput = false;
  private bool showOtherHouseholds = false;

  private bool CanAct() => !string.IsNullOrWhiteSpace(username);

  private void ToggleCreate()
  {
    showCreateInput = !showCreateInput;
    status = null;
  }

  private async Task Create()
  {
    if (!CanAct())
    {
      status = "Enter a username first.";
      return;
    }
    if (string.IsNullOrWhiteSpace(newHousehold))
    {
      status = "Enter a household name.";
      return;
    }

    try
    {
      var household = await HouseholdService.CreateAsync(newHousehold!.Trim(), username!.Trim());
      // After creating, join as the owner to get Member info and persist locally
      var member = await HouseholdService.JoinAsync(household.Code, username!.Trim());
      if (member != null)
      {
        await JS.InvokeVoidAsync("wgChores.setCookie", "wg_member_id", member.Id.ToString(), 365);
        await JS.InvokeVoidAsync("wgChores.setCookie", "wg_member_username", member.Username ?? string.Empty, 365);
        // remember last opened household code
        await JS.InvokeVoidAsync("wgChores.setCookie", "wg_household_code", household.Code, 365);
      }
      status = $"Created household '{household.Name}' â€” code: {household.Code}.";
      newHousehold = string.Empty;
      showCreateInput = false;
      Nav.NavigateTo($"/household/{household.Code}");
    }
    catch (Exception ex)
    {
      status = $"Error creating household: {ex.Message}" + (ex.InnerException != null ? $" - {ex.InnerException.Message}" : string.Empty);
      Console.Error.WriteLine(ex);
    }
  }

  private async Task Join()
  {
    if (!CanAct())
    {
      status = "Enter a username first.";
      return;
    }
    if (string.IsNullOrWhiteSpace(joinCode))
    {
      status = "Enter a household code.";
      return;
    }

    var code = joinCode!.Trim();

    try
    {
      var member = await HouseholdService.JoinAsync(code, username!.Trim());
      if (member == null)
      {
        status = "Household code not found or an error occurred.";
      }
      else
      {
        // persist member id/username locally so household pages can record history
        await JS.InvokeVoidAsync("wgChores.setCookie", "wg_member_id", member.Id.ToString(), 365);
        await JS.InvokeVoidAsync("wgChores.setCookie", "wg_member_username", member.Username ?? string.Empty, 365);
        // remember last opened household code
        await JS.InvokeVoidAsync("wgChores.setCookie", "wg_household_code", code, 365);
        status = $"Joined household (id: {member.HouseholdId}) as {member.Username}.";
        joinCode = string.Empty;
        Nav.NavigateTo($"/household/{code}");
      }
    }
    catch (Exception ex)
    {
      status = $"Error joining household: {ex.Message}" + (ex.InnerException != null ? $" - {ex.InnerException.Message}" : string.Empty);
      Console.Error.WriteLine(ex);
    }
  }

  private async Task ForgotHousehold()
  {
    if (string.IsNullOrWhiteSpace(username))
    {
      status = "Enter a username to search for households.";
      return;
    }

    try
    {
      var households = await HouseholdService.GetByUsernameAsync(username!.Trim());
      // also clear stored member info and last household
      await JS.InvokeVoidAsync("wgChores.deleteCookie", "wg_member_id");
      await JS.InvokeVoidAsync("wgChores.deleteCookie", "wg_member_username");
      await JS.InvokeVoidAsync("wgChores.deleteCookie", "wg_household_code");

      if (households == null || households.Count == 0)
      {
        status = "No households found for that username.";
      }
      else
        {
        status = string.Join("\n", households.Select(h => $"\"{h.Name}\" {h.Code}"));
      }
    }
    catch (Exception ex)
    {
      status = $"Error finding households: {ex.Message}";
      Console.Error.WriteLine(ex);
    }
  }

  protected override async Task OnInitializedAsync()
  {
    // determine application version from assembly attributes (strip any +commit suffix)
    try
    {
      var asm = Assembly.GetEntryAssembly() ?? Assembly.GetExecutingAssembly();
      var raw = asm?.GetCustomAttribute<AssemblyInformationalVersionAttribute>()?.InformationalVersion
                ?? asm?.GetName().Version?.ToString();
      if (string.IsNullOrWhiteSpace(raw)) appVersion = "unknown";
      else appVersion = raw.Split('+')[0];
    }
    catch { appVersion = "unknown"; }

    try
    {
      string code = await JS.InvokeAsync<string>("wgChores.getCookie", "wg_household_code");
      string storedUsername = await JS.InvokeAsync<string>("wgChores.getCookie", "wg_member_username");

      if (!string.IsNullOrWhiteSpace(code))
      {
        storedHouseholdCode = code;
        joinCode = code; // Pre-fill for easy re-join after logout
        var household = await HouseholdService.GetByCodeAsync(code);
        if (household != null)
          storedHouseholdName = household.Name;
        if (!string.IsNullOrWhiteSpace(storedUsername))
        {
          Nav.NavigateTo($"/household/{code}");
        }
      }
    }
    catch { }
  }
}

