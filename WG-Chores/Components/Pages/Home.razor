@page "/"

@inject IHouseholdService HouseholdService
@inject NavigationManager Nav

<PageTitle>Login</PageTitle>

<div class="container-fluid vh-100 d-flex align-items-center justify-content-center bg-light">
  <div class="card shadow-sm" style="max-width:420px; width:100%;">
    <div class="card-body p-4">
      <div class="d-flex align-items-center mb-3">
        <div class="me-2" style="font-size:28px">WG</div>
        <div>
          <h4 class="mb-0">WG-Chores</h4>
          <small class="text-muted">Sign in to manage your household</small>
        </div>
      </div>

      <div class="mb-3 form-floating">
        <input id="username" class="form-control" placeholder="Username" @bind="username" />
        <label for="username">Username</label>
      </div>

      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="d-flex align-items-center" style="gap:12px;">
          <button class="btn btn-sm btn-outline-secondary" @onclick="ToggleCreate" disabled="@(!CanAct())">
            <span class="me-1">+</span>
            <span class="small">Create</span>
          </button>
          <small class="text-muted">or</small>
        </div>

        <div class="d-flex align-items-center" style="gap:8px;">
          <input class="form-control form-control-sm" placeholder="Join code" style="width:140px" @bind="joinCode" />
          <button class="btn btn-sm btn-primary" @onclick="Join">Join</button>
        </div>
      </div>

      @if (showCreateInput)
      {
        <div class="mb-3">
          <div class="input-group">
            <input class="form-control" placeholder="Household name" @bind="newHousehold" />
            <button class="btn btn-primary" @onclick="Create">Create</button>
            <button class="btn btn-outline-secondary" @onclick="() => showCreateInput = false">Cancel</button>
          </div>
        </div>
      }

      @if (!string.IsNullOrEmpty(status))
      {
        <div class="alert alert-info py-2 mt-2" role="status">@status</div>
      }

      <div class="mt-3 text-center">
        <small class="text-muted">Demo auth — local only</small>
      </div>
    </div>
  </div>
</div>

@code {
  private string? username;
  private string? newHousehold;
  private string? joinCode;
  private string? status;

  private bool showCreateInput = false;

  private bool CanAct() => !string.IsNullOrWhiteSpace(username);

  private void ToggleCreate()
  {
    showCreateInput = !showCreateInput;
    status = null;
  }

  private async Task Create()
  {
    if (!CanAct())
    {
      status = "Enter a username first.";
      return;
    }
    if (string.IsNullOrWhiteSpace(newHousehold))
    {
      status = "Enter a household name.";
      return;
    }

    try
    {
      var household = await HouseholdService.CreateAsync(newHousehold!.Trim(), username!.Trim());
      status = $"Created household '{household.Name}' — code: {household.Code}.";
      newHousehold = string.Empty;
      showCreateInput = false;
      Nav.NavigateTo($"/household/{household.Code}");
    }
    catch (Exception ex)
    {
      status = $"Error creating household: {ex.Message}" + (ex.InnerException != null ? $" - {ex.InnerException.Message}" : string.Empty);
      Console.Error.WriteLine(ex);
    }
  }

  private async Task Join()
  {
    if (!CanAct())
    {
      status = "Enter a username first.";
      return;
    }
    if (string.IsNullOrWhiteSpace(joinCode))
    {
      status = "Enter a household code.";
      return;
    }

    var code = joinCode!.Trim();

    try
    {
      var member = await HouseholdService.JoinAsync(code, username!.Trim());
      if (member == null)
      {
        status = "Household code not found or an error occurred.";
      }
      else
      {
        status = $"Joined household (id: {member.HouseholdId}) as {member.Username}.";
        joinCode = string.Empty;
        Nav.NavigateTo($"/household/{code}");
      }
    }
    catch (Exception ex)
    {
      status = $"Error joining household: {ex.Message}" + (ex.InnerException != null ? $" - {ex.InnerException.Message}" : string.Empty);
      Console.Error.WriteLine(ex);
    }
  }
}

